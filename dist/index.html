<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <div id="show"></div>
<script defer src="17d22.main.js"></script></head>
<body>
    <input type="file" name="file" id="file">
    檔名：<input type="text" id="labName">
    檔案類型：<input type="text" id="labExt">
    <input type="button" value="UPLOAD TO FIREBASE STORAGE" id="uploadToStorage">
    <input type="button" value="CANCEL THE IMAGE" id="reset">
    <script defer>
        //------------------------------------------------- VARs & Refs
        const imgToUpload = document.querySelector('#file'),
        btn_upload = document.querySelector('#uploadToStorage'),
        btn_reset = document.querySelector('#reset'),
        labName = document.querySelector('#labName'),
        labExt = document.querySelector('#labExt')

        let myImg
        let imgExt
        let imgName
        
        const uploadToStorage = window._firebase.storage.update
        const findCurUser = window._firebase.auth.findCurrentUser
        const updateToRealtimeDB = _firebase.realtimeDB.writeUserData
        //------------------------------------------------- img檔案的基本判斷
        const checkImgAndGetExt = (img) => {
            //------------------------------------------------- GET EXT
            const _getExt = (file) => {
                const [ext] = file.name
                    .split('/\./')
                    .filter( (item, ind, arr) => { 
                        return ind + 1 === arr.length })
                return ext
            }

            if(!img){
                alert('請選則要上傳的圖片')
                return 
            }
            if((myImg.size / 1024).ceil() > 10){
                alert('圖片必須小於10M')
                return
            }
            const ext =
                _getExt(myImg) === 'png' ? 'png' : 
                _getExt(myImg) === 'jpg' || 'jpeg' ? 'jpeg' :
                false
            if(!ext){   
                alert('僅能選用jpg或png檔')
                return
            }
            return ext
        }
        //------------------------------------------------- Handle For READER
        const createReaderAndGetArrBuf = (file) => {
            return new Promise( (r, j ) => {
                const reader = new FileReader()
                reader.addEventListener('start', (e) => {
                    console.log('圖檔從本地上傳到Browser -- 開始')
                })
                reader.addEventListener('end', (e) => {
                    console.log('圖檔從本地上傳到Browser -- 結束')
                })
                reader.addEventListener('load', (e) => {
                    if(e.readyState === 2) console.log('圖檔從本地上傳到Browser -- 完成')
                    r(reader.response)
                    return
                })
                reader.addEventListener('error', (e) => {
                    console.log('圖檔從本地上傳到Browser -- 發生錯誤, 錯誤為 => ', reader.error)
                    j(reader.error)
                    return
                })
                reader.readAsArrayBuffer(file)
            })
        }
        //------------------------------------------------- GET IMG NAME
        const handleChangeImgName = (originName) => (e) => {
            if(e.target.value.length > 12 ){
                alert('名稱不能超過12位')
                e.target.value = originName
            }else{
                e.target.value =
                !e.target.value ? originName :
                //\u4e00-\u9fa5 中文
                //\u3105-\u3129 注音
                //\u02CA\u02C7\u02CB\u02D9 二三四輕聲
                !/^[\u4e00-\u9fa5\u3105-\u3129\u02CA\u02C7\u02CB\u02D9_a-zA-Z0-9\.]+$/.exec(e.target.value) ? originName :
                e.target.value
            }
            return 
        }
        //------------------------------------------------- REALTIME UPLOAD
        const getUserAndUpdateRealtimeDB = async (avatar) => {
            let { uid, email } = await findCurUser()
            let [ _ , username ] = /^([\w]+)@/.exec(email)
            console.log(`當前用戶為 ${username},其 uid => ${uid}`)
            await updateToRealtimeDB(uid, username, email, avatar)
            console.log('realtime資料寫入 -- 完成')
        }
        
        //------------------------------------------------- ONCHANGE
        const onChange = async ( e ) => {
            myImg = e.target.files[0]
            e.target.setAttribute('disabled', true)
            //若檔案確實存在
            if(myImg){
                //撈取圖片類型
                imgExt = labExt.textContent = checkImgAndGetExt(myImg)
                if(!imgExt){
                    return
                }else{
                    //檔名欄自動填入名稱
                    imgName = labName.value = myImg.name
                        .split('/\./')
                        .reduce((pre, cur,ind,arr)=> {
                            if(ind +1 === arr.length){
                                return pre
                            }else if(!ind){
                                return cur
                            }else{
                                return pre + '.' + cur
                            }
                            return curItem
                        }, '')
                    //檔名欄可改
                    labName.removeAttribute('disabled')
                    labName.addEventListener('change', handleChangeImgName(imgName))
                }
            }else{
                alert('請確實選擇圖檔')
            }
            return
        }
        //------------------------------------------------- ONUPDATE
        const onUpdate = async ( e ) => {
            const response = await createReaderAndGetArrBuf(myImg)
            imgName = labName.value
            fileName = `${imgName}.${imgExt}`
            await uploadToStorage(fileName, response, imgExt)
            console.log('firebase storage上傳成功')
            const avatar = await _firebase.storage.getUrl(fileName)
            console.log('抓取 firebase storage 檔案的 download url -- 完成, url => ', avatar)
            await getUserAndUpdateRealtimeDB(avatar)
            let img = document.createElement('img')
            img.setAttribute('src', avatar);
            document.querySelector('#show').append(img)
        }
        //------------------------------------------------- RESET THE IMG
        const onReset = async (e) => {
            imgToUpload.value = ''
            vimgToUpload.removeAttribute('disabled')
        }
        //------------------------------------------------- add handles
        imgToUpload.addEventListener('change', onChange)
        btn_upload.addEventListener('click', onUpdate)
        btn_reset.addEventListener('click', onReset)
    </script>
</body>
</html>