<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register/Login</title>

  <!-- BS5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">

  <%- include('wedgets/navbar/navbar-css') %>

  <style>
    .loading {
      color: blue
    }
  </style>
</head>

<body>
  <!-- 主導覽 -->
  <%- include('wedgets/navbar/navbar') %>

  <!-- 註冊/登入 互動卡片-->
  <div class="card w-50 mx-auto" style='margin-top: 4rem;'>
    <!-- 卡片頭部 -->
    <div class="card-header">
      <!-- 頭部導行列-->
      <ul class="card-header-tabs nav nav-tabs">
        <!-- 頭部導行項-->
        <li class="nav-item">
          <a class="nav-link <%= active === 'register' ? `active` : `` %>" href="#" data-bs-toggle='tab'
            data-bs-target='#register-box' role="tab" aria-controls="register" aria-selected="true">註冊</a>
        </li>
        <li class="nav-item">
          <a class="nav-link <%= active === 'login'  ? `active` : `` %>" href="#" data-bs-toggle='tab'
            data-bs-target='#login-box' role="tab" aria-controls="login" aria-selected="false">登入</a>
        </li>
      </ul>
    </div>
    <!-- 卡片主體 -->
    <div class="card-body tab-content">
      <div class="tab-pane fade <%= active === 'register' ? `show active` : ``%>" role="tabpanel"
        aria-labelledby="register-tab" id="register-box">
        <form id='form-register' class="row">
          <div class="col-8 mx-auto">
            <div class="mb-3">
              <label for="email" class="form-label">信箱</label>
              <input type="email" class="form-control" name="email" aria-describedby="email_help" autocomplete="off"
                required>
              <div class="d-block">&nbsp;</div>
            </div>
            <div class="mb-3">
              <label for="input_password" class="form-label">密碼</label>
              <input type="password" class="form-control" name="input_password" data-retry='yes'
                autocomplete="new-password" required>
              <div class="d-block">&nbsp;</div>
            </div>
            <div class="mb-3">
              <label for="input_check_password" class="form-label">密碼確認</label>
              <input type="password" class="form-control" name='input_check_password' autocomplete="off" disabled>
              <div class="d-block">&nbsp;</div>
            </div>
            <button type="submit" class="btn btn-primary" disabled>送出</button>
          </div>
        </form>
      </div>
      <div class="tab-pane fade <%= active === 'login'  ? `show active` : ``%>" id="login-box" role="tabpanel"
        aria-labelledby="login-tab">
        <form id='form_login' class="row">
          <div class="col-8 mx-auto">
            <div class="mb-3">
              <label for="input_email" class="form-label">信箱</label>
              <input type="text" class="form-control" name="input_email" data-form-id='#form_login' autocomplete="off"
                required aria-describedby="email_help">
              <div class="d-block">&nbsp;</div>
            </div>
            <div class="mb-3">
              <label for="input_password" class="form-label">密碼</label>
              <input type="password" class="form-control" name="input_password" data-form-id='#form_login'
                autocomplete="new-password">
              <div class="d-block">&nbsp;</div>
            </div>
            <button type="submit" class="btn btn-primary" disabled>送出</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <%- include('wedgets/cdn') %>
  <%- include('wedgets/navbar/navbar-js')  %>

  <script>
    $(function () {
      // //  selector__ 對應 selector
      // const selector__form_register = '#form_register'
      // const selector__form_login = '#form_login'
      // const selector__inp_email = `input[name='input_email']`
      // const selector__inp_password = `input[name='input_password']`
      // const selector__inp_check_password = `input[name='input_check_password']`
      // let selector__feedback_check_password = `${selector__inp_check_password} ~ div`

      // //  $ 對應 ele
      // const $check_password = $(selector__inp_check_password)
      // const $feedback_check_password = $(selector__feedback_check_password)

      /*  BS5 Tab : Register & Login */

      //  手動註冊的 BS5 Tab 列表
      let BS5_tabs = []

      //  手動註冊 BS5 Tab
      $(`.card .nav-link`).each((ind, tab) => {
        //  手動註冊 tab
        const tabTrigger = new bootstrap.Tab(tab)

        //  show.bs.tab 當 tab 內容顯示時
        tab.addEventListener('show.bs.tab', (e) => {
          //  .card .nav-link - 選擇卡的選項群組
          //  #my-navbar-header-register .nav-link - navbar 的 login/register 選項群組
          $(`.card .nav-link, #my-navbar-header-register .nav-link`).each((ind, nav) => {
            $(nav).toggleClass('active')
          })
        })
        BS5_tabs.push(tabTrigger)
      })

      valicate_register('#form-register')

      let regex_password = /^[0-9a-zA-Z_]{6,}$/
      let patten_email = /^[^\s@]+@[^\s@]+\.[^\s@]+[^\\.]$/
      let api_isEmailExist = '/api/user/isEmailExist'

      function valicate_register(selector_form) {
        let valicate_email_front = valicator_email_front(selector_form)
        let valicate_email_server = valicator_email_server(selector_form)
        let valicate_password = valicator_password(selector_form)
        let valicate_password_again = valicator_password_again(selector_form)
        let valicate_submit = valicator_submit(selector_form)

        let Debouncing_email = Debouncing(valicate_email)

        async function valicate_email() {
          valicate_email_front() && await valicate_email_server()
          valicate_submit()
        }

        $(`${selector_form} input[type='email']`).one('change', (e) => {
          Debouncing_email()
          $(e.target).on('input', Debouncing_email)
        })

        $(`${selector_form} input[type='password']`).first().on('change', (e) => {
          let is_valid = valicate_password()
          valicate_submit()
          setDisabled($(`${selector_form} input[type='password']`).last(), is_valid)
        })

        $(`${selector_form} input[type='password']`).last().on('change', (e) => {
          let is_valid = valicate_password_again()
          valicate_submit()
        })


      }

      function valicator_password_again(form_selector) {
        let inp_pwd1 = $(`${form_selector} input[type='password']`).first()
        let inp_pwd2 = $(`${form_selector} input[type='password']`).last()

        return () => {
          let pwd2 = inp_pwd2.val()

          if (!!!pwd2) {
            feedback_UI(inp_pwd2, false, '請再填一次密碼')
            return false
          }

          let pwd1 = inp_pwd1.val()

          let is_valid = pwd1 === pwd2

          if (!is_valid) {
            feedback_UI(inp_pwd2, false, '必須與密碼相同')
            return false
          } else {
            feedback_UI(inp_pwd2, true, 'ok')
            return true
          }
        }
      }

      function valicator_password(selector) {
        let form = $(selector)
        let inp = $(`${selector} input[type='password']`).first()

        return () => {
          feedback_UI(inp, 'load')
          let password = inp.val().trim()

          if (!!!password) {
            feedback_UI(inp, false, '密碼必填，不能為空')
            return false
          } else if (!regex_password.test(password)) {
            feedback_UI(inp, false, '密碼僅能由數字、大小寫英文、底線組成')
            return false
          } else {
            feedback_UI(inp, true, 'ok')
            return true
          }
        }
      }

      function valicator_email_front(selector_form) {
        let inp = $(`${selector_form} input[type='email']`)

        return () => {
          feedback_UI(inp, 'load')

          let email = inp.val()

          if (!!!email) {
            console.log('空')
            feedback_UI(inp, false, '請填入信箱資訊')
            return false
          } else if (!regex_test(email, patten_email, true)) {
            console.log('不符合email格式')
            feedback_UI(inp, false, '不符合email格式')
            return false
          } else {
            return true
          }
        }
      }

      function valicator_email_server(selector_form) {
        let inp = $(`${selector_form} input[type='email']`)

        return async () => {

          feedback_UI(inp, 'load')

          let email = inp.val()

          let { data: { errno, data, msg } } = await axios.post(api_isEmailExist, { email })

          //  後端驗證
          if (!errno) {
            console.log('後端確認email是否可用，成功')
            feedback_UI(inp, true, data)
          } else {
            console.log('後端確認email是否可用，失敗')
            msg = Array.isArray(msg) ? msg[0].message : msg
            feedback_UI(inp, false, msg)
          }
        }
      }

      function valicator_submit(selector_form) {
        let form = $(selector_form)
        let submit = $(`${selector_form} button[type='submit']`)
        let inps = $(`${selector_form} input`)
        let length = inps.length

        return () => {
          let num = 0
          inps.each((index, item) => {
            $(item).hasClass('is-valid') && num++
          })
          let canSubmit = num === length
          console.log(num, length, canSubmit)
          setDisabled(submit, canSubmit)
        }
      }


      function setDisabled(jqObj, boo) {
        jqObj.attr('disabled', (index, val) => {
          if (boo) {
            return false
          } else {
            return 'disabled'
          }
        })
      }


      function feedback_UI(inp, valid, msg) {
        if (valid === 'load') {
          $(inp).next().toggleClass('my-show', true).text('loading...')
        } else if (valid) {
          $(inp).removeClass('is-invalid').addClass('is-valid')
          $(inp).next().removeClass('invalid-feedback myshow').addClass('valid-feedback').text(msg)
        } else {
          $(inp).removeClass('is-valid').addClass('is-invalid')
          $(inp).next().removeClass('valid-feedback myshow').addClass('invalid-feedback').text(msg)
        }
      }

      function _lowercaseAndTrim(str) {
        return str.trim().toLocaleLowerCase()
      }

      function regex_test(str, pattern, toLowercase) {
        if (toLowercase) {
          str = _lowercaseAndTrim(str)
        }

        return pattern.test(str)
      }

      function Debouncing(func, ms = 250) {
        let n
        return () => {
          console.log('test', `@n => ${n}`)
          n && clearTimeout(n)
          n = setTimeout(func, ms)
        }
      }
    })

    function tt() {
      let target = $(e.target)
      let email = target.val()
      let feedback = target.next()

      //  GenericFuc: validate UI for form
      // function _form_UI(selector__form) {
      //   return (selector, empty, invalid) => {
      //     const selector__inp = `${selector__form} ${selector}`
      //     const selector__feedback = `${selector__inp} ~ div`
      //     const selector__submit = `${selector__form} button[type='submit']`

      //     const $inp = $(selector__inp)
      //     const $feedback = $(selector__feedback)
      //     const $submit = $(selector__submit)

      //     const success = !empty && !invalid

      //     const _submit_UI = () => {
      //       const can_submit = $$(`${selector__form} .is-valid`).length === $$(`${selector__form} input`).length
      //       if (!can_submit) {
      //         $submit.setAttribute('disabled', true)
      //       } else {
      //         $submit.removeAttribute('disabled')
      //       }
      //     }

      //     const _input_UI = (_success, empty, invalid) => {
      //       let remove_class_input = !success ? 'is-valid' : 'is-invalid'
      //       let add_class_ = success ? 'is-valid' : 'is-invalid'
      //       let remove_class_feedback = !success ? 'valid-feedback' : 'invalid-feedback'
      //       let add_class_feedback = success ? 'valid-feedback' : 'invalid-feedback'

      //       $inp.classList.remove(`${remove_class_input}`)
      //       $inp.classList.add(`${add_class_}`)
      //       $feedback.classList.remove(remove_class_feedback)
      //       $feedback.classList.add(add_class_feedback)

      //       if (!_success) {
      //         if (empty) {
      //           $feedback.innerHTML = `必填，且必須是數字或大小寫英文字母`
      //         } else if (invalid) {
      //           $feedback.innerHTML = `${invalid}`
      //         }
      //       } else {
      //         $feedback.innerHTML = `ok`
      //       }
      //       _submit_UI()
      //       return
      //     }
      //     _input_UI(success, empty, invalid)
      //   }
      // }

      // //  form_UI_register
      // const form_UI_register = _form_UI(selector__form_register)

      // //  form_UI_login
      // const form_UI_login = _form_UI(selector__form_login)

      // const validate_email = async (e) => {
      //   console.log('進入驗證')
      //   const $target = e.target

      //   let form_id = $target.dataset['formId']
      //   const $feedback = $(`${form_id} ${selector__inp_email} ~ div`)

      //   //  判斷使用 register || login 的 UI驗證
      //   const form_UI = (form_id = form_id === '#form_register') ? form_UI_register : form_UI_login

      //   const email = $target.value
      //   const regex_email = /^[\w]+@[\w\.]+$/
      //   if (!email) {
      //     //  無值
      //     form_UI(selector__inp_email, true)
      //     return
      //   } else if (!(regex_email.exec(email))) {
      //     //  格式錯誤
      //     form_UI(selector__inp_email, false, '必須由數字或英文字母組成')
      //     return
      //   }

      //   //  格式驗證成功
      //   if (form_id) {
      //     //  若是 register_input_email
      //     //  添加 loading 樣式
      //     $target.classList.remove('is-valid', 'is-invalid')
      //     $feedback.classList.add('loading')
      //     $feedback.innerHTML = 'LOADING...'

      //     //  AJAX
      //     let {
      //       data: {
      //         errno,
      //         msg = undefined,
      //         data = undefined
      //       }
      //     } = await axios.post('/api/user/isEmailExist', { email })

      //     //  AJAX結束，移除 loading 樣式
      //     $feedback.classList.remove('loading')

      //     if (errno) {
      //       //  DB驗證失敗
      //       form_UI_register(selector__inp_email, false, msg)
      //       return
      //     } else {
      //       //  DB驗證成功
      //       form_UI_register(selector__inp_email)
      //       return
      //     }
      //   } else {
      //     //  若是 login_input_email
      //     form_UI(selector__inp_email)
      //   }
      // }


      // // 驗證 register email 是否已存在
      // $$(`${selector__inp_email}`).forEach(
      //   inp => inp.addEventListener(
      //     'input',
      //     validate_email
      //   )
      // )

      // //  handle 密碼格式
      // const validate_password = (e) => {
      //   const $target = e.target

      //   const password = $target.value
      //   let form_id = $target.dataset['formId']

      //   let form_UI = (form_id = form_id === '#form_register') ? form_UI_register : form_UI_login
      //   let retry = form_id ? $target.dataset['retry'] : 'no'

      //   if (retry === 'yes') {
      //     $target.dataset['retry'] = 'no'
      //     $check_password.value = ''
      //     $check_password.classList.remove('is-valid', 'is-invalid')
      //     $feedback_check_password.innerHTML = '&nbsp;'
      //   }

      //   if (!password) {
      //     //  無效，密碼為空
      //     form_id && $check_password.setAttribute('disabled', true) && console.log(123456)
      //     form_UI(selector__inp_password, true)
      //     return
      //   } else if (!(/^[\w]+$/.exec(password))) {
      //     //  無效，密碼格式錯誤
      //     form_UI(selector__inp_password, false, '密碼必須由數字或英文字母組成')
      //     form_id && $check_password.setAttribute('disabled', true)
      //     return
      //   } else {
      //     //  有效
      //     if (form_id) {
      //       if ($check_password.hasAttribute('disabled')) {
      //         $check_password.removeAttribute('disabled')
      //       }
      //     }
      //     form_UI(selector__inp_password)
      //     return
      //   }
      // }

      // // form_register 與 form_login 的 inp_password 都需綁定
      // $$(`${selector__inp_password}`).forEach(inp => {
      //   inp.addEventListener('input', validate_password)
      // })

      // //  form_register 的 inp_password 更改 password 時，checkout_password 的 UI變化
      // $(`${selector__form_register} ${selector__inp_password}`).addEventListener(
      //   'blur',
      //   e => {
      //     e.target.dataset['retry'] = 'yes'
      //   })

      // //  handle 密碼二次
      // const handle_checkout_password = (e) => {
      //   const $password = $(`${selector__form_register} ${selector__inp_password}`)
      //   const password = $password.value
      //   const check_password = $check_password.value

      //   const valid = password === check_password

      //   if (!valid) {
      //     form_UI_register(selector__inp_check_password, false, '請確認兩次密碼都是一樣的')
      //   } else {
      //     form_UI_register(selector__inp_check_password)
      //   }
      //   return
      // }

      // $check_password.addEventListener(
      //   'input',
      //   handle_checkout_password
      // )

      // //  送出註冊資料
      // $(selector__form_register).addEventListener(
      //   'submit',
      //   async (e) => {
      //     e.preventDefault()
      //     const email = $(`${selector__form_register} ${selector__inp_email}`).value
      //     const password = $(`${selector__form_register} ${selector__inp_password}`).value
      //     const {
      //       data: {
      //         errno,
      //         msg = undefined,
      //         data = undefined
      //       }
      //     } = await axios.post('/api/user/register', {
      //       email,
      //       password
      //     })
      //     if (errno) {
      //       alert(msg.message)
      //     } else {
      //       //window.userCredential = await _firebase.auth.create( email, password )
      //       alert('註冊成功，請嘗試登入')
      //       location.href = '/login'

      //     }
      //   })

      // //  送出登入資料
      // $(selector__form_login).addEventListener(
      //   'submit',
      //   async (e) => {
      //     e.preventDefault()
      //     const {
      //       data: {
      //         errno,
      //         msg = undefined,
      //         data = undefined
      //       }
      //     } = await axios.post('/api/user/', {
      //       email: $(`${selector__form_login} ${selector__inp_email}`).value,
      //       password: $(`${selector__form_login} ${selector__inp_password}`).value
      //     })
      //     if (errno) {
      //       alert(msg)
      //     } else {
      //       alert('登入成功')
      //       let from = location.search ? new URLSearchParams(location.search).get('from') : false
      //       location.href = from || '/self'
      //     }
      //   })
    }
  </script>
</body>

</html>