<script>
    $(function () {
        $('#more_news > button').click(async (e) => {
            e.preventDefault()
            let confirm_time = $('#navbarDropdown').attr('data-confirm_time')
            let api = e.target.dataset.api
            const {
                data: {
                    errno, data, msg
                }
            } = await axios.get(api)
            if (!errno) {
                let { str: { confirm, unconfirm }, more, index, count } = data
                if(count){
                    $('.new-count').text(count)
                    $('.new-count').addClass('my-show')
                }
                let new_news_hrs = $('[data-my-tag="new-news-hr"]')
                let target = new_news_hrs[new_news_hrs.length - 1]
                $(target).after(unconfirm)
                if(more){
                    $('#more_news').attr('data-api', `/api/user/moreNews?index=${index}&confirm_time=${confirm_time}`)
                }else{
                    $('#more_news').toggle()
                    $('#nonews').toggle()
                }
                console.log('ok')
            } else {
                alert(msg)
            }
        })

        $('#navbarDropdown').one('click' , (async (e) => {
            e.preventDefault()
            //  若初次渲染的view，confirm 當前顯示的新通知
            if($(e.target).attr('data-my-first-render')){
                let payload = { fans: [], blogs: []}
                //  蒐集fans、blog消息的 news_id
                $('li[data-my-news-type]').each( (ind, item) => {
                    if( $(item).attr('data-my-news-type') === 'fans'){
                        fans.push( $(item).attr('data-my-news-id') )
                    }
                    if( $(item).attr('data-my-news-type') === 'blog'){
                        blogs.push( $(item).attr('data-my-news-id') )
                    }
                })

                //  confirm 當前 news
                let {
                    data: { errno, data, msg }
                } = await axios.post('/api/news/confirm', payload)

                if(!errno){
                    //  成功，重設、移除相關 data-set
                    console.log('已完成confirm')
                    $(e.target).attr('data-my-first-render', false)
                    $('li[data-my-news-type]').each( (ind, item) => {
                        $(item).removeAttr(['data-my-news-type', 'data-my-news-id'])
                    })
                }else{
                    console.log('confirm失敗 => ', msg)
                }
            }
            
            if($('.news-count')){
                let confirm_time = $('#navbarDropdown').attr('data-confirm_time')
                
                const {
                    data: {
                        errno, data, msg
                    }
                } = await axios.get(`/api/user/news_confirm?confirm_time=${confirm_time}`)

                if(!errno){
                    console.log('ok')
                    $('.news-count').remove()
                }
                errno && console.log('noooo')
            } 
        }))
    })
console.log('news JS 1')
</script>