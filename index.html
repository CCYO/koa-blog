<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <div id="show"></div>
</head>
<body>
    <div>
        <img id="avatarImg"/>
    </div>
    <input type="file" name="file" id="file"><br>
    檔名：<input type="text" id="labName" disabled>
    檔案類型：<span id="labExt"></span><br>
    <input type="button" value="UPLOAD TO FIREBASE STORAGE" id="uploadToStorage">
    <input type="button" value="CANCEL THE IMAGE" id="reset">
    <style>
        #avatarImg {
            display: none;
        }
    </style>
    <div>
        <span id="percentFromLocal"></span>%
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.2/spark-md5.min.js"></script>
    <script defer>
        window.onload = function(){
        //------------------------------------------------- VARs & Refs
        const avatarImg = document.querySelector('#avatarImg'),
        imgToUpload = document.querySelector('#file'),
        btn_upload = document.querySelector('#uploadToStorage'),
        btn_reset = document.querySelector('#reset'),
        labName = document.querySelector('#labName'),
        labExt = document.querySelector('#labExt'),
        labPercent = document.querySelector('#percentFromLocal')

        let myImg
        let imgExt
        

        const SparkMD5 = window.SparkMD5

        const uploadToStorage = window._firebase.storage.update
        const findCurUser = window._firebase.auth.findCurrentUser
        const readFromRealtimeDB = _firebase.realtimeDB.readUserData
        const updateToRealtimeDB = _firebase.realtimeDB.writeUserData
        //------------------------------------------------- img檔案的基本判斷
        const checkImgAndGetExt = (img) => {
            //------------------------------------------------- GET EXT
            const _getExt = (file) => {
                const [ext] = file.name
                    .split(/\./)
                    .filter( (item, ind, arr) => { 
                        return ind + 1 === arr.length })
                return ext
            }

            if(!img){
                alert('請選則要上傳的圖片')
                return 
            }
            console.log(img.size)
            if(Math.ceil(img.size / (1024 * 1024) ) > 10){
                alert('圖片必須小於10M')
                return
            }
            const ext = _getExt(img)
            if(!ext){   
                alert('僅能選用jpg或png檔')
                return false
            }
            return ext
        }
        //------------------------------------------------- Handle For READER
        const createReaderAndGetArrBuf = (file, options) => {
            return new Promise( (r, j ) => {
                const reader = new FileReader()
                reader.addEventListener('loadstart', (e) => {
                    console.log('圖檔從本地上傳到Browser -- 開始')
                })
                reader.addEventListener('loadend', (e) => {
                    console.log('圖檔從本地上傳到Browser -- 結束')
                })
                reader.addEventListener('progress', (e) => {
                    const loaded = e.loaded
                    const total = e.total
                    const percent = Math.ceil( (loaded/total) * 100 )
                    if(e.target.readyState === 1) console.log('圖檔從本地上傳到Browser -- ING')
                    console.log(`圖檔從本地上傳到Browser -- ${percent}%`)
                    if(options.labPercent){
                        options.labPercent.textContent = percent
                    }
                })
                reader.addEventListener('load', (e) => {
                    if(e.target.readyState === 2) console.log('圖檔從本地上傳到Browser -- 完成')
                    r(reader.result)
                    return
                })
                reader.addEventListener('error', (e) => {
                    console.log('圖檔從本地上傳到Browser -- 發生錯誤, 錯誤為 => ', reader.error)
                    j(reader.error)
                    return
                })
                reader.readAsArrayBuffer(file)
            })
        }
        //------------------------------------------------- GET IMG NAME
        const handleChangeImgName = (originName) => (e) => {
            if(e.target.value.length > 12 ){
                alert('名稱不能超過12位')
                e.target.value = originName
            }else{
                e.target.value =
                !e.target.value ? originName :
                //\u4e00-\u9fa5 中文
                //\u3105-\u3129 注音
                //\u02CA\u02C7\u02CB\u02D9 二三四輕聲
                !/^[\u4e00-\u9fa5\u3105-\u3129\u02CA\u02C7\u02CB\u02D9_a-zA-Z0-9\.]+$/.exec(e.target.value) ? originName :
                e.target.value
            }
            return 
        }
        //------------------------------------------------- REALTIME UPLOAD
        const getUserAndUpdateRealtimeDB = async ({avatarHash, avatarUrl}) => {
            let { uid, email } = await findCurUser()
            let [ _ , username ] = /^([\w]+)@/.exec(email)
            console.log(`當前用戶為 ${username},其 uid => ${uid}`)
            await updateToRealtimeDB(uid, username, email, avatarHash, avatarUrl)
            console.log('realtime資料寫入 -- 完成')
        }
        
        //------------------------------------------------- ONCHANGE
        const onChange = async ( e ) => {
            myImg = e.target.files[0]
            //若檔案確實存在
            if(myImg){
                //撈取圖片類型
                imgExt = labExt.textContent = checkImgAndGetExt(myImg)
                if(!imgExt){
                    e.target.value = ''
                    return
                }else{
                    //檔名欄自動填入名稱
                    imgName = labName.value = myImg.name
                        .split(/\./)
                        .reduce((pre, cur,ind,arr)=> {
                            if(ind +1 === arr.length){
                                return pre
                            }else if(!ind){
                                return cur
                            }else{
                                return pre + '.' + cur
                            }
                            return curItem
                        }, '')
                    e.target.setAttribute('disabled', true)
                    //檔名欄可改
                    labName.removeAttribute('disabled')
                    labName.addEventListener('change', handleChangeImgName(imgName))
                }
            }else{
                alert('請確實選擇圖檔')
            }
            return
        }
        //------------------------------------------------- ONUPDATE
        const onUpdate = async ( e ) => {
            const response = await createReaderAndGetArrBuf(myImg, {labPercent})
            const spark = new SparkMD5.ArrayBuffer()
            const avatarHash = spark.append(response).end()
            const imgName = labName.value
            const fileName = `${imgName}.${imgExt}`
            let user = await findCurUser()
            let avatarUrl
            if(!user){
                alert('尚未登入')
            }else{
                const snapshot = await readFromRealtimeDB(user.uid)
                if(snapshot.exists() && snapshot.child('avatarHash').val() === avatarHash){
                    alert('已完成上傳')
                    avatarUrl = snapshot.child('avatarUrl').val()
                }else{
                    await uploadToStorage('avatar', user.uid, fileName, response, imgExt)
                    console.log('firebase storage上傳成功')
                    avatarUrl = await _firebase.storage.getUrl('avatar', user.uid, fileName)
                    console.log('抓取 firebase storage 檔案的 download url -- 完成, url => ', avatarUrl)
                    await getUserAndUpdateRealtimeDB({avatarHash, avatarUrl})
                }
                console.log(avatarUrl)
                avatarImg.setAttribute('src', avatarUrl);
                avatarImg.style.display = 'block'
            }
            return
        }
        //------------------------------------------------- RESET THE IMG
        const onReset = async (e) => {
            imgToUpload.value = labExt.textContent = labName.value = myImg = ''
            labPercent.textContent = ''
            avatarImg.setAttribute('src', '');
            avatarImg.style.display = 'none'
            imgToUpload.removeAttribute('disabled')
        }
        //------------------------------------------------- add handles
        imgToUpload.addEventListener('change', onChange)
        btn_upload.addEventListener('click', onUpdate)
        btn_reset.addEventListener('click', onReset)
    }
    </script>
</body>
</html>